(function($){function TimeEntry(){this._disabledInputs=[];this.regional=[];this.regional['']={show24Hours:false,separator:':',ampmPrefix:' ',ampmNames:['AM','PM'],spinnerTexts:['Now','Previous field','Next field','Increment','Decrement']};this._defaults={appendText:'',showSeconds:false,timeSteps:[1,1,1],initialField:0,noSeparatorEntry:false,useMouseWheel:true,defaultTime:null,minTime:null,maxTime:null,spinnerImage:'spinnerDefault.png',spinnerSize:[20,20,8],spinnerBigImage:'',spinnerBigSize:[40,40,16],spinnerIncDecOnly:false,spinnerRepeat:[500,250],beforeShow:null,beforeSetTime:null};$.extend(this._defaults,this.regional['']);}$.extend(TimeEntry.prototype,{markerClassName:'hasTimeEntry',propertyName:'timeEntry',_appendClass:'timeEntry_append',_controlClass:'timeEntry_control',_expandClass:'timeEntry_expand',setDefaults:function(options){$.extend(this._defaults,options||{});return this;},_attachPlugin:function(target,options){var input=$(target);if(input.hasClass(this.markerClassName)){return;}var inst={options:$.extend({},this._defaults,options),input:input,_field:0,_selectedHour:0,_selectedMinute:0,_selectedSecond:0};input.data(this.propertyName,inst).addClass(this.markerClassName).bind('focus.'+this.propertyName,this._doFocus).bind('blur.'+this.propertyName,this._doBlur).bind('click.'+this.propertyName,this._doClick).bind('keydown.'+this.propertyName,this._doKeyDown).bind('keypress.'+this.propertyName,this._doKeyPress).bind('paste.'+this.propertyName,function(event){setTimeout(function(){plugin._parseTime(inst);},1);});this._optionPlugin(target,options);},_optionPlugin:function(target,options,value){target=$(target);var inst=target.data(this.propertyName);if(!options||(typeof options=='string'&&value==null)){var name=options;options=(inst||{}).options;return(options&&name?options[name]:options);}if(!target.hasClass(this.markerClassName)){return;}options=options||{};if(typeof options=='string'){var name=options;options={};options[name]=value;}var currentTime=this._extractTime(inst);$.extend(inst.options,options);inst._field=0;if(currentTime){this._setTime(inst,new Date(0,0,0,currentTime[0],currentTime[1],currentTime[2]));}target.next('span.'+this._appendClass).remove();target.parent().find('span.'+this._controlClass).remove();if($.fn.mousewheel){target.unmousewheel();}var spinner=(!inst.options.spinnerImage?null:$('<span class="'+this._controlClass+'" style="display: inline-block; '+'background: url(\''+inst.options.spinnerImage+'\') 0 0 no-repeat; width: '+inst.options.spinnerSize[0]+'px; height: '+inst.options.spinnerSize[1]+'px;"></span>'));target.after(inst.options.appendText?'<span class="'+this._appendClass+'">'+inst.options.appendText+'</span>':'').after(spinner||'');if(inst.options.useMouseWheel&&$.fn.mousewheel){target.mousewheel(this._doMouseWheel);}if(spinner){spinner.mousedown(this._handleSpinner).mouseup(this._endSpinner).mouseover(this._expandSpinner).mouseout(this._endSpinner).mousemove(this._describeSpinner);}},_enablePlugin:function(target){this._enableDisable(target,false);},_disablePlugin:function(target){this._enableDisable(target,true);},_enableDisable:function(target,disable){var inst=$.data(target,this.propertyName);if(!inst){return;}target.disabled=disable;if(target.nextSibling&&target.nextSibling.nodeName.toLowerCase()=='span'){plugin._changeSpinner(inst,target.nextSibling,(disable?5:-1));}plugin._disabledInputs=$.map(plugin._disabledInputs,function(value){return(value==target?null:value);});if(disable){plugin._disabledInputs.push(target);}},_isDisabledPlugin:function(target){return $.inArray(target,this._disabledInputs)>-1;},_destroyPlugin:function(target){target=$(target);if(!target.hasClass(this.markerClassName)){return;}target.removeClass(this.markerClassName).removeData(this.propertyName).unbind('.'+this.propertyName);if($.fn.mousewheel){target.unmousewheel();}this._disabledInputs=$.map(this._disabledInputs,function(value){return(value==target[0]?null:value);});target.siblings('.'+this._appendClass+',.'+this._controlClass).remove();},_setTimePlugin:function(target,time){var inst=$.data(target,this.propertyName);if(inst){if(time===null||time===''){inst.input.val('');}else{this._setTime(inst,time?(typeof time=='object'?new Date(time.getTime()):time):null);}}},_getTimePlugin:function(target){var inst=$.data(target,this.propertyName);var currentTime=(inst?this._extractTime(inst):null);return(!currentTime?null:new Date(0,0,0,currentTime[0],currentTime[1],currentTime[2]));},_getOffsetPlugin:function(target){var inst=$.data(target,this.propertyName);var currentTime=(inst?this._extractTime(inst):null);return(!currentTime?0:(currentTime[0]*3600+currentTime[1]*60+currentTime[2])*1000);},_doFocus:function(target){var input=(target.nodeName&&target.nodeName.toLowerCase()=='input'?target:this);if(plugin._lastInput==input||plugin._isDisabledPlugin(input)){plugin._focussed=false;return;}var inst=$.data(input,plugin.propertyName);plugin._focussed=true;plugin._lastInput=input;plugin._blurredInput=null;$.extend(inst.options,($.isFunction(inst.options.beforeShow)?inst.options.beforeShow.apply(input,[input]):{}));plugin._parseTime(inst);setTimeout(function(){plugin._showField(inst);},10);},_doBlur:function(event){plugin._blurredInput=plugin._lastInput;plugin._lastInput=null;},_doClick:function(event){var input=event.target;var inst=$.data(input,plugin.propertyName);if(!plugin._focussed){var fieldSize=inst.options.separator.length+2;inst._field=0;if(input.selectionStart!=null){for(var field=0;field<=Math.max(1,inst._secondField,inst._ampmField);field++){var end=(field!=inst._ampmField?(field*fieldSize)+2:(inst._ampmField*fieldSize)+inst.options.ampmPrefix.length+inst.options.ampmNames[0].length);inst._field=field;if(input.selectionStart<end){break;}}}else if(input.createTextRange){var src=$(event.srcElement);var range=input.createTextRange();var convert=function(value){return{thin:2,medium:4,thick:6}[value]||value;};var offsetX=event.clientX+document.documentElement.scrollLeft-(src.offset().left+parseInt(convert(src.css('border-left-width')),10))-range.offsetLeft;for(var field=0;field<=Math.max(1,inst._secondField,inst._ampmField);field++){var end=(field!=inst._ampmField?(field*fieldSize)+2:(inst._ampmField*fieldSize)+inst.options.ampmPrefix.length+inst.options.ampmNames[0].length);range.collapse();range.moveEnd('character',end);inst._field=field;if(offsetX<range.boundingWidth){break;}}}}plugin._showField(inst);plugin._focussed=false;},_doKeyDown:function(event){if(event.keyCode>=48){return true;}var inst=$.data(event.target,plugin.propertyName);switch(event.keyCode){case 9:return(event.shiftKey?plugin._changeField(inst,-1,true):plugin._changeField(inst,+1,true));case 35:if(event.ctrlKey){plugin._setValue(inst,'');}else{inst._field=Math.max(1,inst._secondField,inst._ampmField);plugin._adjustField(inst,0);}break;case 36:if(event.ctrlKey){plugin._setTime(inst);}else{inst._field=0;plugin._adjustField(inst,0);}break;case 37:plugin._changeField(inst,-1,false);break;case 38:plugin._adjustField(inst,+1);break;case 39:plugin._changeField(inst,+1,false);break;case 40:plugin._adjustField(inst,-1);break;case 46:plugin._setValue(inst,'');break;default:return true;}return false;},_doKeyPress:function(event){var chr=String.fromCharCode(event.charCode==undefined?event.keyCode:event.charCode);if(chr<' '){return true;}var inst=$.data(event.target,plugin.propertyName);plugin._handleKeyPress(inst,chr);return false;},_doMouseWheel:function(event,delta){if(plugin._isDisabledPlugin(event.target)){return;}var inst=$.data(event.target,plugin.propertyName);inst.input.focus();if(!inst.input.val()){plugin._parseTime(inst);}plugin._adjustField(inst,delta);event.preventDefault();},_expandSpinner:function(event){var spinner=plugin._getSpinnerTarget(event);var inst=$.data(plugin._getInput(spinner),plugin.propertyName);if(plugin._isDisabledPlugin(inst.input[0])){return;}if(inst.options.spinnerBigImage){inst._expanded=true;var offset=$(spinner).offset();var relative=null;$(spinner).parents().each(function(){var parent=$(this);if(parent.css('position')=='relative'||parent.css('position')=='absolute'){relative=parent.offset();}return!relative;});$('<div class="'+plugin._expandClass+'" style="position: absolute; left: '+(offset.left-(inst.options.spinnerBigSize[0]-inst.options.spinnerSize[0])/2-(relative?relative.left:0))+'px; top: '+(offset.top-(inst.options.spinnerBigSize[1]-inst.options.spinnerSize[1])/2-(relative?relative.top:0))+'px; width: '+inst.options.spinnerBigSize[0]+'px; height: '+inst.options.spinnerBigSize[1]+'px; background: transparent url('+inst.options.spinnerBigImage+') no-repeat 0px 0px; z-index: 10;"></div>').mousedown(plugin._handleSpinner).mouseup(plugin._endSpinner).mouseout(plugin._endExpand).mousemove(plugin._describeSpinner).insertAfter(spinner);}},_getInput:function(spinner){return $(spinner).siblings('.'+plugin.markerClassName)[0];},_describeSpinner:function(event){var spinner=plugin._getSpinnerTarget(event);var inst=$.data(plugin._getInput(spinner),plugin.propertyName);spinner.title=inst.options.spinnerTexts[plugin._getSpinnerRegion(inst,event)];},_handleSpinner:function(event){var spinner=plugin._getSpinnerTarget(event);var input=plugin._getInput(spinner);if(plugin._isDisabledPlugin(input)){return;}if(input==plugin._blurredInput){plugin._lastInput=input;plugin._blurredInput=null;}var inst=$.data(input,plugin.propertyName);plugin._doFocus(input);var region=plugin._getSpinnerRegion(inst,event);plugin._changeSpinner(inst,spinner,region);plugin._actionSpinner(inst,region);plugin._timer=null;plugin._handlingSpinner=true;if(region>=3&&inst.options.spinnerRepeat[0]){plugin._timer=setTimeout(function(){plugin._repeatSpinner(inst,region);},inst.options.spinnerRepeat[0]);$(spinner).one('mouseout',plugin._releaseSpinner).one('mouseup',plugin._releaseSpinner);}},_actionSpinner:function(inst,region){if(!inst.input.val()){plugin._parseTime(inst);}switch(region){case 0:this._setTime(inst);break;case 1:this._changeField(inst,-1,false);break;case 2:this._changeField(inst,+1,false);break;case 3:this._adjustField(inst,+1);break;case 4:this._adjustField(inst,-1);break;}},_repeatSpinner:function(inst,region){if(!plugin._timer){return;}plugin._lastInput=plugin._blurredInput;this._actionSpinner(inst,region);this._timer=setTimeout(function(){plugin._repeatSpinner(inst,region);},inst.options.spinnerRepeat[1]);},_releaseSpinner:function(event){clearTimeout(plugin._timer);plugin._timer=null;},_endExpand:function(event){plugin._timer=null;var spinner=plugin._getSpinnerTarget(event);var input=plugin._getInput(spinner);var inst=$.data(input,plugin.propertyName);$(spinner).remove();inst._expanded=false;},_endSpinner:function(event){plugin._timer=null;var spinner=plugin._getSpinnerTarget(event);var input=plugin._getInput(spinner);var inst=$.data(input,plugin.propertyName);if(!plugin._isDisabledPlugin(input)){plugin._changeSpinner(inst,spinner,-1);}if(plugin._handlingSpinner){plugin._lastInput=plugin._blurredInput;}if(plugin._lastInput&&plugin._handlingSpinner){plugin._showField(inst);}plugin._handlingSpinner=false;},_getSpinnerTarget:function(event){return event.target||event.srcElement;},_getSpinnerRegion:function(inst,event){var spinner=this._getSpinnerTarget(event);var pos=$(spinner).offset();var scrolled=[document.documentElement.scrollLeft||document.body.scrollLeft,document.documentElement.scrollTop||document.body.scrollTop];var left=(inst.options.spinnerIncDecOnly?99:event.clientX+scrolled[0]-pos.left);var top=event.clientY+scrolled[1]-pos.top;var spinnerSize=inst.options[inst._expanded?'spinnerBigSize':'spinnerSize'];var right=(inst.options.spinnerIncDecOnly?99:spinnerSize[0]-1-left);var bottom=spinnerSize[1]-1-top;if(spinnerSize[2]>0&&Math.abs(left-right)<=spinnerSize[2]&&Math.abs(top-bottom)<=spinnerSize[2]){return 0;}var min=Math.min(left,top,right,bottom);return(min==left?1:(min==right?2:(min==top?3:4)));},_changeSpinner:function(inst,spinner,region){$(spinner).css('background-position','-'+((region+1)*inst.options[inst._expanded?'spinnerBigSize':'spinnerSize'][0])+'px 0px');},_parseTime:function(inst){var currentTime=this._extractTime(inst);if(currentTime){inst._selectedHour=currentTime[0];inst._selectedMinute=currentTime[1];inst._selectedSecond=currentTime[2];}else{var now=this._constrainTime(inst);inst._selectedHour=now[0];inst._selectedMinute=now[1];inst._selectedSecond=(inst.options.showSeconds?now[2]:0);}inst._secondField=(inst.options.showSeconds?2:-1);inst._ampmField=(inst.options.show24Hours?-1:(inst.options.showSeconds?3:2));inst._lastChr='';inst._field=Math.max(0,Math.min(Math.max(1,inst._secondField,inst._ampmField),inst.options.initialField));if(inst.input.val()!=''){this._showTime(inst);}},_extractTime:function(inst,value){value=value||inst.input.val();var currentTime=value.split(inst.options.separator);if(inst.options.separator==''&&value!=''){currentTime[0]=value.substring(0,2);currentTime[1]=value.substring(2,4);currentTime[2]=value.substring(4,6);}if(currentTime.length>=2){var isAM=!inst.options.show24Hours&&(value.indexOf(inst.options.ampmNames[0])>-1);var isPM=!inst.options.show24Hours&&(value.indexOf(inst.options.ampmNames[1])>-1);var hour=parseInt(currentTime[0],10);hour=(isNaN(hour)?0:hour);hour=((isAM||isPM)&&hour==12?0:hour)+(isPM?12:0);var minute=parseInt(currentTime[1],10);minute=(isNaN(minute)?0:minute);var second=(currentTime.length>=3?parseInt(currentTime[2],10):0);second=(isNaN(second)||!inst.options.showSeconds?0:second);return this._constrainTime(inst,[hour,minute,second]);}return null;},_constrainTime:function(inst,fields){var specified=(fields!=null);if(!specified){var now=this._determineTime(inst.options.defaultTime,inst)||new Date();fields=[now.getHours(),now.getMinutes(),now.getSeconds()];}var reset=false;for(var i=0;i<inst.options.timeSteps.length;i++){if(reset){fields[i]=0;}else if(inst.options.timeSteps[i]>1){fields[i]=Math.round(fields[i]/inst.options.timeSteps[i])*inst.options.timeSteps[i];reset=true;}}return fields;},_showTime:function(inst){var currentTime=(this._formatNumber(inst.options.show24Hours?inst._selectedHour:((inst._selectedHour+11)%12)+1)+inst.options.separator+this._formatNumber(inst._selectedMinute)+(inst.options.showSeconds?inst.options.separator+this._formatNumber(inst._selectedSecond):'')+(inst.options.show24Hours?'':inst.options.ampmPrefix+inst.options.ampmNames[(inst._selectedHour<12?0:1)]));this._setValue(inst,currentTime);this._showField(inst);},_showField:function(inst){var input=inst.input[0];if(inst.input.is(':hidden')||plugin._lastInput!=input){return;}var fieldSize=inst.options.separator.length+2;var start=(inst._field!=inst._ampmField?(inst._field*fieldSize):(inst._ampmField*fieldSize)-inst.options.separator.length+inst.options.ampmPrefix.length);var end=start+(inst._field!=inst._ampmField?2:inst.options.ampmNames[0].length);if(input.setSelectionRange){input.setSelectionRange(start,end);}else if(input.createTextRange){var range=input.createTextRange();range.moveStart('character',start);range.moveEnd('character',end-inst.input.val().length);range.select();}if(!input.disabled){input.focus();}},_formatNumber:function(value){return(value<10?'0':'')+value;},_setValue:function(inst,value){if(value!=inst.input.val()){inst.input.val(value).trigger('change');}},_changeField:function(inst,offset,moveOut){var atFirstLast=(inst.input.val()==''||inst._field==(offset==-1?0:Math.max(1,inst._secondField,inst._ampmField)));if(!atFirstLast){inst._field+=offset;}this._showField(inst);inst._lastChr='';return(atFirstLast&&moveOut);},_adjustField:function(inst,offset){if(inst.input.val()==''){offset=0;}this._setTime(inst,new Date(0,0,0,inst._selectedHour+(inst._field==0?offset*inst.options.timeSteps[0]:0)+(inst._field==inst._ampmField?offset*12:0),inst._selectedMinute+(inst._field==1?offset*inst.options.timeSteps[1]:0),inst._selectedSecond+(inst._field==inst._secondField?offset*inst.options.timeSteps[2]:0)));},_setTime:function(inst,time){time=this._determineTime(time,inst);var fields=this._constrainTime(inst,time?[time.getHours(),time.getMinutes(),time.getSeconds()]:null);time=new Date(0,0,0,fields[0],fields[1],fields[2]);var time=this._normaliseTime(time);var minTime=this._normaliseTime(this._determineTime(inst.options.minTime,inst));var maxTime=this._normaliseTime(this._determineTime(inst.options.maxTime,inst));time=(minTime&&time<minTime?minTime:(maxTime&&time>maxTime?maxTime:time));if($.isFunction(inst.options.beforeSetTime)){time=inst.options.beforeSetTime.apply(inst.input[0],[this._getTimePlugin(inst.input[0]),time,minTime,maxTime]);}inst._selectedHour=time.getHours();inst._selectedMinute=time.getMinutes();inst._selectedSecond=time.getSeconds();this._showTime(inst);},_determineTime:function(setting,inst){var offsetNumeric=function(offset){var time=new Date();time.setTime(time.getTime()+offset*1000);return time;};var offsetString=function(offset){var fields=plugin._extractTime(inst,offset);var time=new Date();var hour=(fields?fields[0]:time.getHours());var minute=(fields?fields[1]:time.getMinutes());var second=(fields?fields[2]:time.getSeconds());if(!fields){var pattern=/([+-]?[0-9]+)\s*(s|S|m|M|h|H)?/g;var matches=pattern.exec(offset);while(matches){switch(matches[2]||'s'){case's':case'S':second+=parseInt(matches[1],10);break;case'm':case'M':minute+=parseInt(matches[1],10);break;case'h':case'H':hour+=parseInt(matches[1],10);break;}matches=pattern.exec(offset);}}time=new Date(0,0,10,hour,minute,second,0);if(/^!/.test(offset)){if(time.getDate()>10){time=new Date(0,0,10,23,59,59);}else if(time.getDate()<10){time=new Date(0,0,10,0,0,0);}}return time;};return(setting?(typeof setting=='string'?offsetString(setting):(typeof setting=='number'?offsetNumeric(setting):setting)):null);},_normaliseTime:function(time){if(!time){return null;}time.setFullYear(1900);time.setMonth(0);time.setDate(0);return time;},_handleKeyPress:function(inst,chr){if(chr==inst.options.separator){this._changeField(inst,+1,false);}else if(chr>='0'&&chr<='9'){var key=parseInt(chr,10);var value=parseInt(inst._lastChr+chr,10);var hour=(inst._field!=0?inst._selectedHour:(inst.options.show24Hours?(value<24?value:key):(value>=1&&value<=12?value:(key>0?key:inst._selectedHour))%12+(inst._selectedHour>=12?12:0)));var minute=(inst._field!=1?inst._selectedMinute:(value<60?value:key));var second=(inst._field!=inst._secondField?inst._selectedSecond:(value<60?value:key));var fields=this._constrainTime(inst,[hour,minute,second]);this._setTime(inst,new Date(0,0,0,fields[0],fields[1],fields[2]));if(inst.options.noSeparatorEntry&&inst._lastChr){this._changeField(inst,+1,false);}else{inst._lastChr=chr;}}else if(!inst.options.show24Hours){chr=chr.toLowerCase();if((chr==inst.options.ampmNames[0].substring(0,1).toLowerCase()&&inst._selectedHour>=12)||(chr==inst.options.ampmNames[1].substring(0,1).toLowerCase()&&inst._selectedHour<12)){var saveField=inst._field;inst._field=inst._ampmField;this._adjustField(inst,+1);inst._field=saveField;this._showField(inst);}}}});var getters=['getOffset','getTime','isDisabled'];function isNotChained(command,otherArgs){if(command=='option'&&(otherArgs.length==0||(otherArgs.length==1&&typeof otherArgs[0]=='string'))){return true;}return $.inArray(command,getters)>-1;}$.fn.timeEntry=function(options){var otherArgs=Array.prototype.slice.call(arguments,1);if(isNotChained(options,otherArgs)){return plugin['_'+options+'Plugin'].apply(plugin,[this[0]].concat(otherArgs));}return this.each(function(){if(typeof options=='string'){if(!plugin['_'+options+'Plugin']){throw'Unknown command: '+options;}plugin['_'+options+'Plugin'].apply(plugin,[this].concat(otherArgs));}else{var inlineSettings=($.fn.metadata?$(this).metadata():{});plugin._attachPlugin(this,$.extend({},inlineSettings,options||{}));}});};var plugin=$.timeEntry=new TimeEntry();})(jQuery);window.puJsFileLoadCounter++;